<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>داشبورد کنترل</title>
    <style>
        body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
        h1 { color: #333; }
        select, textarea, input, button { margin: 10px 0; width: 100%; padding: 8px; }
        #clients { margin-top: 20px; }
        .client-item { cursor: pointer; padding: 5px; background: #fff; margin-bottom: 5px; border: 1px solid #ccc; }
        .client-item:hover { background: #e0e0e0; }
        #logs { background: #fff; padding: 10px; border: 1px solid #ccc; height: 200px; overflow-y: scroll; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>داشبورد کنترل از راه دور</h1>

    <h2>کلاینت‌ها</h2>
    <div id="clients"></div>

    <h2>دستور آماده</h2>
    <select id="preset">
        <option value="">-- انتخاب دستور --</option>
        <option value="show_notification">نمایش نوتیفیکیشن</option>
        <option value="get_system_info">گرفتن اطلاعات سیستم</option>
        <option value="execute_shell">اجرای دستور شل</option>
    </select>

    <h2>دستور سفارشی</h2>
    <textarea id="custom" rows="6" placeholder="اینجا کد پایتون بنویس..."></textarea>

    <button onclick="sendCommand()">ارسال دستور</button>

    <h2>لاگ‌ها</h2>
    <div id="logs">هیچ کلاینتی انتخاب نشده</div>

    <script>
        let selectedClient = null;

        async function loadClients() {
            const res = await fetch("/clients");
            const data = await res.json();
            const container = document.getElementById("clients");
            container.innerHTML = "";
            data.clients.forEach(id => {
                const div = document.createElement("div");
                div.className = "client-item";
                div.textContent = id;
                div.onclick = () => selectClient(id);
                container.appendChild(div);
            });
        }

        async function selectClient(id) {
            selectedClient = id;
            const res = await fetch(`/logs/${id}`);
            const data = await res.json();
            document.getElementById("logs").textContent = data.logs.join("\n");
        }

        async function sendCommand() {
            if (!selectedClient) {
                alert("هیچ کلاینتی انتخاب نشده");
                return;
            }

            let code = document.getElementById("custom").value;
            const preset = document.getElementById("preset").value;

            if (preset === "show_notification") {
                code = `from plyer import notification\nnotification.notify(title='پیام سرور', message='سلام محسن!')`;
            } else if (preset === "get_system_info") {
                code = `import platform\nprint(platform.uname())`;
            } else if (preset === "execute_shell") {
                code = `import subprocess\nprint(subprocess.getoutput('echo Hello from shell'))`;
            }

            if (!code.trim()) {
                alert("دستور خالی است");
                return;
            }

            await fetch(`/send/${selectedClient}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ command: code })
            });

            alert("دستور ارسال شد!");
        }

        window.onload = loadClients;
    </script>
</body>
</html>
